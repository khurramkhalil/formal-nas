apiVersion: batch/v1
kind: Job
metadata:
  name: formal-nas-unified-search
spec:
  template:
    spec:
      containers:
      - name: unified-search
        image: python:3.9-slim
        env:
          - name: WANDB_API_KEY
            value: "c7ea31e5793ba44d95d91840a10d709378eb2d9d"
          - name: WANDB_PROJECT
            value: "formal-nas-unified"
          - name: WANDB_ENTITY
            value: "khurramkhalil"
          - name: PYTHONPATH
            value: "/data/TransNASBench:$PYTHONPATH"
        command: ["/bin/bash", "-c"]
        args:
          - |
            # 1. Install Dependencies
            echo "Installing dependencies..."
            apt-get update && apt-get install -y git build-essential
            pip install z3-solver matplotlib wandb python-dotenv numpy torch scipy
            
            # Link Data
            echo "Linking TransNAS Data..."
            find /data -name "transnas-bench_v10141024.pth" -exec ln -s {} /formal-nas/transnas-bench_v10141024.pth \;
            
            # 2. Setup Workspace
            cd /formal-nas
            
            # 3. Run Experiment
            echo "Running Unified Formal NAS Search..."
            python experiments/run_unified_search.py --iterations 50 --target-acc 90.0
        
        resources:
          limits:
            memory: 16Gi
            cpu: 8
            nvidia.com/gpu: 0 # CPU Logic Job
          requests:
            memory: 8Gi
            cpu: 4
            
        volumeMounts:
        - mountPath: /formal-nas
          name: work-volume
        - mountPath: /data
          name: data-volume
      
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: NotIn
                values:
                - hcc-nrp-shor-c5934.unl.edu
      
      restartPolicy: Never
      
      volumes:
      - name: work-volume
        persistentVolumeClaim:
          claimName: formal-nas-pvc
      - name: data-volume
        persistentVolumeClaim:
          claimName: nasbench201-data
